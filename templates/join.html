<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TEAM SECRET â€” Join</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#000;
  --neon-cyan:#00ffff;
  --neon-purple:#b800ff;
  --neon-pink:#ff00ff;
  --glow-cyan:rgba(0,255,255,0.8);
  --glow-purple:rgba(184,0,255,0.6);
  --neon-green:#00ff00;
  --glow-green:rgba(0,255,0,0.8);
}

*{margin:0;padding:0;box-sizing:border-box}

body{
  font-family:'Rajdhani', sans-serif;
  background:#000;
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
  color:white;
  position:relative;
  padding:20px;
  overflow-x:hidden;
}

/* Main Container */
.container{
  background:linear-gradient(135deg, rgba(0,20,40,0.8) 0%, rgba(20,0,40,0.8) 100%);
  padding:clamp(40px, 5vw, 60px) clamp(30px, 5vw, 70px);
  border-radius:30px;
  border:2px solid;
  border-image:linear-gradient(135deg, var(--neon-cyan), var(--neon-purple), var(--neon-pink)) 1;
  backdrop-filter:blur(20px);
  text-align:center;
  position:relative;
  animation:float-container 5s ease-in-out infinite alternate;
  box-shadow:
    0 0 60px rgba(0,255,255,0.4),
    0 0 100px rgba(184,0,255,0.3),
    inset 0 0 40px rgba(0,255,255,0.1);
  z-index:10;
  max-width:min(500px, 90vw);
  width:100%;
  margin:auto;
  overflow:hidden;
}

@keyframes float-container{
  0%{
    transform:translateY(0) scale(1);
  }
  100%{
    transform:translateY(-15px) scale(1.02);
  }
}

/* Logo/Badge */
.logo-badge{
  width:clamp(80px, 15vw, 100px);
  height:clamp(80px, 15vw, 100px);
  margin:0 auto 20px;
  border-radius:50%;
  background:linear-gradient(135deg, var(--neon-cyan), var(--neon-purple));
  display:flex;
  align-items:center;
  justify-content:center;
  box-shadow:
    0 0 30px var(--glow-cyan),
    0 0 50px var(--glow-purple);
  animation:pulse-badge 2s infinite ease-in-out;
  position:relative;
  padding:5px;
}

@keyframes pulse-badge{
  0%,100%{
    transform:scale(1);
    box-shadow:
      0 0 30px var(--glow-cyan),
      0 0 50px var(--glow-purple);
  }
  50%{
    transform:scale(1.1);
    box-shadow:
      0 0 50px var(--glow-cyan),
      0 0 70px var(--glow-purple),
      0 0 90px rgba(255,0,255,0.3);
  }
}

.logo-badge img{
  width:100%;
  height:100%;
  border-radius:50%;
  object-fit:cover;
}

/* Title */
h1{
  font-family:'Orbitron', sans-serif;
  font-weight:900;
  font-size:clamp(2em, 6vw, 3.2em);
  background:linear-gradient(135deg, var(--neon-cyan) 0%, var(--neon-purple) 50%, var(--neon-pink) 100%);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  background-clip:text;
  margin:0 0 15px 0;
  letter-spacing:4px;
  text-shadow:0 0 30px var(--glow-cyan);
  animation:glow-title 3s infinite alternate ease-in-out;
  line-height:1.2;
}

/* Status */
.status{
  font-size:clamp(1.2em, 4vw, 1.5em);
  color:#fff;
  margin:20px 0 10px 0;
  font-weight:300;
  letter-spacing:2px;
  text-transform:uppercase;
  position:relative;
  display:inline-block;
  padding:0 40px;
}

/* Full Name Display */
.fullname-display{
  font-size:clamp(1.2em, 4vw, 1.4em);
  color:var(--neon-cyan);
  margin:0 0 30px 0;
  font-weight:600;
  letter-spacing:1px;
  text-shadow:0 0 15px var(--glow-cyan);
  font-family:'Orbitron', sans-serif;
  animation:pulse-name 3s infinite ease-in-out;
  min-height:30px;
  line-height:1.3;
  padding:0 10px;
  word-wrap:break-word;
}

@keyframes pulse-name{
  0%,100%{
    opacity:0.8;
    text-shadow:0 0 10px var(--glow-cyan);
  }
  50%{
    opacity:1;
    text-shadow:
      0 0 20px var(--glow-cyan),
      0 0 10px var(--glow-purple);
  }
}

/* Join Now Button */
.join-now-button{
  padding:clamp(16px, 4vw, 20px) clamp(30px, 6vw, 60px);
  font-size:clamp(1.1em, 3vw, 1.3em);
  border-radius:50px;
  border:2px solid var(--neon-green);
  background:linear-gradient(135deg, rgba(0,255,0,0.3), rgba(0,128,0,0.3));
  color:#fff;
  cursor:pointer;
  transition:all 0.3s ease;
  font-family:'Orbitron', sans-serif;
  font-weight:700;
  letter-spacing:3px;
  text-transform:uppercase;
  position:relative;
  overflow:hidden;
  box-shadow:
    0 0 20px var(--glow-green),
    inset 0 0 20px rgba(0,255,0,0.1);
  display:block;
  text-decoration:none;
  margin:20px auto;
  width:100%;
  max-width:300px;
}

.join-now-button:hover{
  background:linear-gradient(135deg, rgba(0,255,0,0.5), rgba(0,128,0,0.5));
  transform:translateY(-3px) scale(1.05);
  box-shadow:
    0 0 40px var(--glow-green),
    0 0 60px rgba(0,128,0,0.5),
    0 10px 30px rgba(0,0,0,0.5);
  border-color:#00cc00;
}

.button-text{
  position:relative;
  z-index:1;
}

/* Loading Animation */
.loading{
  display:none;
  font-size:1em;
  color:#aaf;
  margin:20px 0;
  letter-spacing:1px;
  animation:pulse-loading 1.5s infinite ease-in-out;
}

@keyframes pulse-loading{
  0%,100%{opacity:0.5}
  50%{opacity:1}
}

/* Features */
.features{
  display:flex;
  justify-content:center;
  gap:clamp(15px, 3vw, 30px);
  margin-top:25px;
  font-size:clamp(0.8em, 2vw, 0.95em);
  color:#aaf;
  flex-wrap:wrap;
}

.feature{
  display:flex;
  align-items:center;
  gap:8px;
  font-weight:300;
  letter-spacing:1px;
}

.feature-icon{
  width:8px;
  height:8px;
  background:var(--neon-green);
  border-radius:50%;
  box-shadow:0 0 10px var(--glow-green);
  animation:pulse-icon 2s infinite ease-in-out;
}

@keyframes pulse-icon{
  0%,100%{
    transform:scale(1);
    opacity:0.7;
  }
  50%{
    transform:scale(1.3);
    opacity:1;
  }
}

/* Message Box */
.message-box{
  background:rgba(0,40,80,0.5);
  border:2px solid var(--neon-cyan);
  border-radius:15px;
  padding:20px;
  margin:20px 0;
  text-align:left;
  font-size:0.95em;
  line-height:1.6;
}

.message-box h3{
  color:var(--neon-cyan);
  margin-bottom:10px;
  font-family:'Orbitron', sans-serif;
}

.message-box ul{
  padding-left:20px;
  margin:10px 0;
}

.message-box li{
  margin-bottom:8px;
}

/* Simple Ad Notice */
.ad-notice{
  background:rgba(255,215,0,0.1);
  border:1px solid rgba(255,215,0,0.3);
  border-radius:10px;
  padding:15px;
  margin:15px 0;
  font-size:0.9em;
  color:#ffd700;
}

.ad-notice i{
  margin-right:8px;
}

/* Responsive */
@media(max-width:480px){
  body{padding:10px}
  .container{
    padding:30px 20px;
    border-radius:20px;
  }
  .status{padding:0 20px}
  .join-now-button{
    padding:15px 30px;
    font-size:1.1em;
  }
  .features{
    flex-direction:column;
    gap:10px;
  }
}
</style>
</head>
<body>

<div class='container'>
  <div class='logo-badge'>
    <img src='https://i.ibb.co/8g2YxXq6/tmpyb9cwaub.jpg' alt='Team Secret Logo'>
  </div>
  
  <h1>TEAM SECRET</h1>
  <div class='status'>Access Granted</div>
  <div id="fullname" class='fullname-display'>User</div>
  
  <!-- Ad Notice -->
  <div class="ad-notice">
    <i class="fas fa-ad"></i> Please watch a short ad to access the protected content
  </div>
  
  <!-- Message Box with Instructions -->
  <div class="message-box">
    <h3>ðŸ“± How to Join:</h3>
    <p>Follow these simple steps:</p>
    <ul>
      <li>1. Click the "Watch Ad & Join" button below</li>
      <li>2. A short advertisement will play (5-10 seconds)</li>
      <li>3. After the ad, you'll be redirected to the Telegram group</li>
      <li>4. The WebApp will close automatically</li>
    </ul>
    <p><strong>Note:</strong> If the ad doesn't load, wait 5 seconds and try again.</p>
  </div>
  
  <!-- Join Button -->
  <a href="#" id="joinBtn" class='join-now-button'>
    <span class='button-text'>Watch Ad & Join Group</span>
  </a>
  
  <!-- Loading -->
  <div id="loading" class='loading'>Processing...</div>
  
  <!-- Manual Link Display -->
  <div id="manualLink" style="display:none; margin-top:20px;">
    <p style="color:#aaa; font-size:0.9em; margin-bottom:10px;">If automatic redirect doesn't work:</p>
    <a href="#" id="directLink" style="color:#00ffff; text-decoration:none; word-break:break-all; font-size:0.9em;">Click here to join manually</a>
  </div>
  
  <div class='features'>
    <div class='feature'>
      <div class='feature-icon'></div>
      <span>Verified</span>
    </div>
    <div class='feature'>
      <div class='feature-icon'></div>
      <span>Secure</span>
    </div>
    <div class='feature'>
      <div class='feature-icon'></div>
      <span>Exclusive</span>
    </div>
  </div>
</div>

<!-- SIMPLE SCRIPT SOLUTION -->
<script>
// Get token from URL or template
const token = "{{ token }}";

// Display user's name if available
try {
    const urlParams = new URLSearchParams(window.location.search);
    const userId = urlParams.get('user_id');
    const userName = urlParams.get('username');
    if (userName) {
        document.getElementById('fullname').textContent = decodeURIComponent(userName);
    }
} catch(e) {
    console.log('Could not get user info');
}

// Main function to handle join
async function handleJoin() {
    const joinBtn = document.getElementById('joinBtn');
    const loading = document.getElementById('loading');
    const manualLinkDiv = document.getElementById('manualLink');
    
    // Disable button and show loading
    joinBtn.style.opacity = '0.6';
    joinBtn.style.cursor = 'not-allowed';
    joinBtn.querySelector('.button-text').textContent = 'Loading...';
    loading.style.display = 'block';
    
    try {
        // STEP 1: Get the group link from server
        loading.textContent = 'Getting group link...';
        const response = await fetch(`/getgrouplink/${token}`);
        
        if (!response.ok) {
            throw new Error('Failed to get group link');
        }
        
        const data = await response.json();
        const groupUrl = data.url;
        
        if (!groupUrl) {
            throw new Error('No group link found');
        }
        
        // STEP 2: Store the link for manual access
        const directLink = document.getElementById('directLink');
        directLink.href = groupUrl;
        directLink.textContent = groupUrl;
        
        // STEP 3: Show ad first (using simple approach)
        loading.textContent = 'Loading advertisement...';
        
        // Create a simple ad overlay
        const adOverlay = document.createElement('div');
        adOverlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            text-align: center;
            padding: 20px;
        `;
        
        adOverlay.innerHTML = `
            <div style="font-size: 1.5em; color: #00ffff; margin-bottom: 20px;">
                ðŸ“º Advertisement
            </div>
            <div style="margin-bottom: 30px; max-width: 400px;">
                Please wait while the ad loads...<br>
                This will close in <span id="countdown">5</span> seconds
            </div>
            <div style="background: rgba(0,255,255,0.1); padding: 20px; border-radius: 10px; border: 1px solid #00ffff; margin-bottom: 20px;">
                <strong>Sponsored Content</strong><br>
                Support our bot by watching this short ad
            </div>
            <button id="skipAdBtn" style="padding: 10px 20px; background: #ff8c00; color: white; border: none; border-radius: 25px; cursor: pointer;">
                Skip Ad & Join Now
            </button>
        `;
        
        document.body.appendChild(adOverlay);
        
        // Countdown timer
        let countdown = 5;
        const countdownElement = document.getElementById('countdown');
        const countdownInterval = setInterval(() => {
            countdown--;
            countdownElement.textContent = countdown;
            
            if (countdown <= 0) {
                clearInterval(countdownInterval);
                completeRedirect(groupUrl, adOverlay);
            }
        }, 1000);
        
        // Skip ad button
        document.getElementById('skipAdBtn').onclick = () => {
            clearInterval(countdownInterval);
            completeRedirect(groupUrl, adOverlay);
        };
        
        // Also redirect if user clicks anywhere
        adOverlay.onclick = (e) => {
            if (e.target === adOverlay) {
                clearInterval(countdownInterval);
                completeRedirect(groupUrl, adOverlay);
            }
        };
        
    } catch (error) {
        console.error('Error:', error);
        loading.textContent = 'Error! Please try again';
        
        // Show manual link as fallback
        manualLinkDiv.style.display = 'block';
        
        // Reset button after 3 seconds
        setTimeout(() => {
            resetButton();
        }, 3000);
    }
}

// Function to complete redirect
function completeRedirect(groupUrl, adOverlay) {
    // Remove ad overlay
    if (adOverlay && adOverlay.parentNode) {
        adOverlay.parentNode.removeChild(adOverlay);
    }
    
    // Show final message
    const loading = document.getElementById('loading');
    loading.textContent = 'Redirecting to group...';
    
    // Try to open Telegram link
    try {
        // Try WebApp method first
        if (window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.openTelegramLink(groupUrl);
        } else {
            // Fallback: open in new tab
            window.open(groupUrl, '_blank');
        }
        
        // Close WebApp after 2 seconds
        setTimeout(() => {
            try {
                if (window.Telegram && window.Telegram.WebApp) {
                    window.Telegram.WebApp.close();
                }
            } catch(e) {
                // WebApp already closed
            }
        }, 2000);
        
    } catch (e) {
        // Show manual link
        document.getElementById('manualLink').style.display = 'block';
        loading.textContent = 'Click the link above to join manually';
    }
}

// Function to reset button
function resetButton() {
    const joinBtn = document.getElementById('joinBtn');
    const loading = document.getElementById('loading');
    
    joinBtn.style.opacity = '1';
    joinBtn.style.cursor = 'pointer';
    joinBtn.querySelector('.button-text').textContent = 'Watch Ad & Join Group';
    loading.style.display = 'none';
}

// Attach click event
document.getElementById('joinBtn').addEventListener('click', function(e) {
    e.preventDefault();
    handleJoin();
});

// Add Font Awesome for icons
const faScript = document.createElement('script');
faScript.src = 'https://kit.fontawesome.com/a076d05399.js';
faScript.crossOrigin = 'anonymous';
document.head.appendChild(faScript);
</script>

</body>
</html>