<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TEAM SECRET — Verification</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
/* ... (keep all existing CSS styles, they're good) ... */

/* Channel Logo Styles - Updated */
.channel-logo {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  margin-right: 15px;
  object-fit: cover;
  border: 2px solid rgba(0, 255, 255, 0.3);
  box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
  background: linear-gradient(135deg, rgba(0, 255, 255, 0.2), rgba(184, 0, 255, 0.2));
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 18px;
  flex-shrink: 0;
}

.channel-logo i {
  font-size: 20px;
}

.channel-logo img {
  width: 100%;
  height: 100%;
  border-radius: 50%;
  object-fit: cover;
}

/* ... (rest of the CSS remains the same) ... */
</style>
</head>
<body>

<div id="grid-bg"></div>
<canvas id='matrix-bg'></canvas>
<div class='particles'></div>

<div class='ring-container'>
  <div class='neon-ring ring1'></div>
  <div class='neon-ring ring2'></div>
  <div class='neon-ring ring3'></div>
</div>

<div class='radial-glow'></div>

<div class='container'>
  <div class='logo-badge'>
    <img src='https://i.ibb.co/8g2YxXq6/tmpyb9cwaub.jpg' alt='Team Secret Logo'>
  </div>
  <h1>TEAM SECRET</h1>
  <div class='status'>Channel Verification</div>
  <div id="fullname" class='fullname-display'>Loading...</div>
  
  <div class='scanning'>
    <div class='scan-line'></div>
  </div>
  
  <div class='content-area'>
    <!-- Initial State: Verify Button -->
    <div id="initial-state" class='button-container'>
      <div class="required-info">
        <i class="fas fa-info-circle"></i> You need to join all required channels to access the protected content
      </div>
      <button id="verifyBtn" class='verify-button'>
        <span class='button-text'>Verify Membership</span>
      </button>
    </div>
    
    <!-- Verification Result -->
    <div id="result-section">
      <div id="result-message" class='result-message'></div>
      
      <!-- Progress Bar -->
      <div id="progress-container" class="progress-container" style="display: none;">
        <div class="progress-header">
          <span class="progress-label">Verification Progress</span>
          <span id="progress-percentage" class="progress-percentage">0%</span>
        </div>
        <div class="progress-bar">
          <div id="progress-fill" class="progress-fill"></div>
        </div>
      </div>
      
      <!-- Channels List -->
      <div id="channels-container" class="channels-container" style="display: none;">
        <div id="channels-list" class="channels-list"></div>
      </div>
      
      <!-- Action Buttons -->
      <div id="action-buttons" class='button-container'></div>
    </div>
    
    <!-- Loading -->
    <div id="loading" class='loading'>Processing verification...</div>
  </div>
</div>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
// Global variables
const token = "{{ token }}";
const tg = window.Telegram.WebApp;

// DOM Elements
const fullnameElement = document.getElementById('fullname');
const initialState = document.getElementById('initial-state');
const resultSection = document.getElementById('result-section');
const resultMessage = document.getElementById('result-message');
const actionButtons = document.getElementById('action-buttons');
const channelsContainer = document.getElementById('channels-container');
const progressContainer = document.getElementById('progress-container');
const progressFill = document.getElementById('progress-fill');
const progressPercentage = document.getElementById('progress-percentage');
const channelsList = document.getElementById('channels-list');
const loading = document.getElementById('loading');
const verifyBtn = document.getElementById('verifyBtn');

// Initialize Telegram WebApp
tg.ready();
tg.expand();
tg.enableClosingConfirmation();

/* Matrix Background */
const canvas = document.getElementById('matrix-bg');
const ctx = canvas.getContext('2d');

function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890@#$%^&*()';
const arr = chars.split('');
const fontSize = 14;
let cols = Math.floor(canvas.width / fontSize);
let drops = new Array(cols).fill(1);

function drawMatrix() {
  ctx.fillStyle = 'rgba(0,0,0,0.05)';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  ctx.fillStyle = 'rgba(0,255,255,0.5)';
  ctx.font = fontSize + 'px monospace';
  
  for (let i = 0; i < drops.length; i++) {
    const text = arr[Math.floor(Math.random() * arr.length)];
    ctx.fillText(text, i * fontSize, drops[i] * fontSize);
    if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) {
      drops[i] = 0;
    }
    drops[i]++;
  }
}

// Start matrix animation
const matrixInterval = setInterval(drawMatrix, 40);

/* Floating Particles */
const particleContainer = document.querySelector('.particles');
for(let i = 0; i < 40; i++){
  let particle = document.createElement('div');
  particle.classList.add('particle');
  particle.style.left = Math.random() * 100 + '%';
  particle.style.top = Math.random() * 100 + '%';
  particle.style.animationDelay = (Math.random() * 8) + 's';
  particle.style.animationDuration = (5 + Math.random() * 5) + 's';
  particleContainer.appendChild(particle);
}

// Display user's full name
function displayFullName() {
    const user = tg.initDataUnsafe?.user;
    if (user) {
        let displayName = user.first_name || '';
        if (user.last_name) {
            displayName += ' ' + user.last_name;
        }
        if (!displayName.trim() && user.username) {
            displayName = `@${user.username}`;
        }
        fullnameElement.textContent = displayName.trim() || 'User';
    } else {
        fullnameElement.textContent = 'User';
    }
}
displayFullName();

function showLoading() {
    initialState.style.display = 'none';
    resultSection.style.display = 'none';
    channelsContainer.style.display = 'none';
    progressContainer.style.display = 'none';
    loading.style.display = 'block';
}

function updateProgress(joinedCount, totalCount) {
    if (totalCount > 0) {
        const percentage = Math.round((joinedCount / totalCount) * 100);
        progressFill.style.width = `${percentage}%`;
        progressPercentage.textContent = `${percentage}%`;
        progressContainer.style.display = 'block';
    } else {
        progressContainer.style.display = 'none';
    }
}

// Improved logo system
function getChannelIcon(channelData) {
    // Try to get the best icon based on available data
    const channelTitle = (channelData.channel_title || channelData.display_name || '').toLowerCase();
    const channelId = channelData.channel || '';
    
    // First, check if we have a specific logo for this channel ID or username
    const specificLogos = {
        // You can add specific channel IDs or usernames here
        '@teamsecret': 'fa-shield-alt',
        '@teamofficial': 'fa-crown',
        'teamsecret': 'fa-shield-alt',
        'teamofficial': 'fa-crown',
        '-100': 'fa-lock', // Private channels
    };
    
    // Check for specific channel IDs or usernames
    for (const [key, icon] of Object.entries(specificLogos)) {
        if (channelId.includes(key) || channelTitle.includes(key)) {
            return icon;
        }
    }
    
    // Then check based on channel title keywords
    if (channelTitle.includes('news') || channelTitle.includes('announce')) {
        return 'fa-bullhorn';
    } else if (channelTitle.includes('crypto') || channelTitle.includes('trading')) {
        return 'fa-chart-line';
    } else if (channelTitle.includes('signal') || channelTitle.includes('alert')) {
        return 'fa-bell';
    } else if (channelTitle.includes('team') || channelTitle.includes('group')) {
        return 'fa-users';
    } else if (channelTitle.includes('official')) {
        return 'fa-check-circle';
    } else if (channelTitle.includes('private') || channelId.startsWith('-100')) {
        return 'fa-lock';
    } else if (channelTitle.includes('channel')) {
        return 'fa-hashtag';
    } else if (channelTitle.includes('support') || channelTitle.includes('help')) {
        return 'fa-headset';
    } else if (channelTitle.includes('premium') || channelTitle.includes('vip')) {
        return 'fa-gem';
    } else if (channelTitle.includes('secret') || channelTitle.includes('exclusive')) {
        return 'fa-user-secret';
    } else if (channelId.startsWith('@')) {
        return 'fa-telegram';
    } else {
        return 'fa-broadcast-tower';
    }
}

// Simple logo URL getter - returns URL or null
function getChannelLogoUrl(channelData) {
    const channelTitle = (channelData.channel_title || channelData.display_name || '').toLowerCase();
    const channelId = channelData.channel || '';
    
    // Only return logo URL for specific known channels
    // Add your channel-specific logos here
    const channelLogos = {
        'teamsecret': 'https://i.ibb.co/8g2YxXq6/tmpyb9cwaub.jpg',
        '@teamsecret': 'https://i.ibb.co/8g2YxXq6/tmpyb9cwaub.jpg',
        'teamofficial': 'https://i.ibb.co/8g2YxXq6/tmpyb9cwaub.jpg',
        'team secret': 'https://i.ibb.co/8g2YxXq6/tmpyb9cwaub.jpg',
    };
    
    // Check for exact matches first
    for (const [key, logoUrl] of Object.entries(channelLogos)) {
        const lowerKey = key.toLowerCase();
        if (channelTitle === lowerKey || 
            channelTitle.includes(lowerKey) || 
            channelId.toLowerCase().includes(lowerKey)) {
            return logoUrl;
        }
    }
    
    // Check for partial matches
    for (const [key, logoUrl] of Object.entries(channelLogos)) {
        const lowerKey = key.toLowerCase();
        if (channelTitle.includes(lowerKey) || channelId.toLowerCase().includes(lowerKey)) {
            return logoUrl;
        }
    }
    
    return null; // No specific logo found
}

function formatChannelName(channel) {
    if (channel.startsWith('@')) {
        return channel.substring(1).replace(/_/g, ' ').toUpperCase();
    } else if (channel.startsWith('-100')) {
        return 'PRIVATE CHANNEL';
    } else {
        return channel.toUpperCase();
    }
}

function createChannelsList(channels) {
    channelsList.innerHTML = '';
    
    if (!channels || channels.length === 0) {
        channelsContainer.style.display = 'none';
        return 0; // Return joined count
    }
    
    let joinedCount = 0;
    
    channels.forEach((channel, index) => {
        const channelItem = document.createElement('div');
        // Use channel_title from backend, fallback to display_name, then format
        const channelTitle = channel.channel_title || channel.display_name || formatChannelName(channel.channel);
        const isJoined = channel.is_member || false;
        
        if (isJoined) joinedCount++;
        
        // Get logo URL or icon
        const logoUrl = getChannelLogoUrl(channel);
        const channelIcon = getChannelIcon(channel);
        
        channelItem.className = `channel-item ${isJoined ? 'joined' : 'not-joined'}`;
        channelItem.innerHTML = `
            <div class="channel-info">
                <div class="channel-logo">
                    ${logoUrl ? 
                        `<img src="${logoUrl}" alt="${channelTitle}" onerror="this.style.display='none'; this.parentElement.innerHTML='<i class=\\'fas ${channelIcon}\\'></i>';" />` : 
                        `<i class="fas ${channelIcon}"></i>`
                    }
                </div>
                <div class="channel-details">
                    <div class="channel-name">${channelTitle}</div>
                    <div class="channel-id">${channel.channel}</div>
                </div>
            </div>
            <div class="channel-status">
                <div class="status-indicator ${isJoined ? 'status-joined' : 'status-not-joined'}">
                    ${isJoined ? '✓' : '✗'}
                </div>
                <div class="status-text ${isJoined ? 'text-joined' : 'text-not-joined'}">
                    ${isJoined ? 'Joined' : 'Not Joined'}
                </div>
                ${!isJoined && channel.invite_link ? `
                    <a href="${channel.invite_link}" target="_blank" class="join-channel-button">
                        <span class="button-text">Join</span>
                    </a>
                ` : ''}
            </div>
        `;
        
        channelsList.appendChild(channelItem);
    });
    
    channelsContainer.style.display = 'block';
    return joinedCount;
}

function showResult(message, isSuccess, channels, channelCount) {
    loading.style.display = 'none';
    resultMessage.textContent = message;
    
    if (isSuccess) {
        resultMessage.className = 'result-message success-message';
        
        // Show all channels with status
        const joinedCount = createChannelsList(channels);
        updateProgress(joinedCount, channelCount);
        
        actionButtons.innerHTML = `
            <button id="joinNowBtn" class="join-now-button">
                <span class="button-text">Access Protected Content</span>
            </button>
            <button id="checkAgainBtn" class="check-again-button">
                <span class="button-text">Verify Again</span>
            </button>
        `;
    } else {
        resultMessage.className = 'result-message warning-message';
        
        // Show all channels with status
        const joinedCount = createChannelsList(channels);
        updateProgress(joinedCount, channelCount);
        
        // Create buttons HTML
        let buttonsHTML = '';
        
        // Add "Join All" button if there are channels not joined
        if (channels && channels.length > 0 && joinedCount < channels.length) {
            buttonsHTML += `
                <button id="joinAllBtn" class="join-all-button">
                    <span class="button-text"><i class="fas fa-external-link-alt"></i> Open All Channels</span>
                </button>
            `;
        }
        
        buttonsHTML += `
            <button id="checkAgainBtn" class="check-again-button">
                <span class="button-text">Verify Membership Again</span>
            </button>
        `;
        
        actionButtons.innerHTML = buttonsHTML;
    }
    
    initialState.style.display = 'none';
    resultSection.style.display = 'flex';
    
    // Add event listeners to new buttons
    setTimeout(() => {
        const joinNowBtn = document.getElementById('joinNowBtn');
        const checkAgainBtn = document.getElementById('checkAgainBtn');
        const joinAllBtn = document.getElementById('joinAllBtn');
        
        if (joinNowBtn) {
            joinNowBtn.addEventListener('click', joinGroup);
        }
        
        if (checkAgainBtn) {
            checkAgainBtn.addEventListener('click', resetToInitialState);
        }
        
        if (joinAllBtn && channels) {
            joinAllBtn.addEventListener('click', () => {
                // Open all channels that are not joined in new tabs
                let openedCount = 0;
                channels.forEach(channel => {
                    if (!channel.is_member && channel.invite_link) {
                        window.open(channel.invite_link, '_blank');
                        openedCount++;
                    }
                });
                
                if (openedCount > 0) {
                    setTimeout(() => {
                        alert(`Opened ${openedCount} channel(s) in new tabs. Please join them and then click "Verify Membership Again".`);
                    }, 500);
                } else {
                    alert("All channels are already joined!");
                }
            });
        }
    }, 100);
}

function resetToInitialState() {
    resultSection.style.display = 'none';
    channelsContainer.style.display = 'none';
    progressContainer.style.display = 'none';
    initialState.style.display = 'flex';
    verifyBtn.disabled = false;
    verifyBtn.querySelector('.button-text').textContent = 'Verify Membership';
}

// Join group function
async function joinGroup() {
    const joinBtn = document.getElementById('joinNowBtn');
    if (joinBtn) {
        joinBtn.disabled = true;
        joinBtn.querySelector('.button-text').textContent = 'Loading...';
    }
    
    loading.style.display = 'block';
    loading.textContent = 'Opening protected content...';
    
    try {
        const response = await fetch(`/getgrouplink/${token}`);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.url) {
            tg.openTelegramLink(data.url);
            setTimeout(() => tg.close(), 1500);
        } else {
            alert('Error: Could not retrieve the protected link.');
            if (joinBtn) {
                joinBtn.disabled = false;
                joinBtn.querySelector('.button-text').textContent = 'Access Protected Content';
            }
            loading.style.display = 'none';
        }
    } catch (error) {
        console.error('Join error:', error);
        alert('An error occurred. Please try again.');
        if (joinBtn) {
            joinBtn.disabled = false;
            joinBtn.querySelector('.button-text').textContent = 'Access Protected Content';
        }
        loading.style.display = 'none';
    }
}

// Verification function
async function verifyMembership() {
    const user = tg.initDataUnsafe?.user;
    
    if (!user || !user.id) {
        showResult('User information not available. Please open this in Telegram.', false, [], 0);
        return;
    }
    
    const userId = user.id;
    
    // Show loading
    verifyBtn.disabled = true;
    verifyBtn.querySelector('.button-text').textContent = 'Checking...';
    showLoading();
    
    try {
        // Call verification API
        const response = await fetch(`/check_membership/${token}?user_id=${userId}`);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        // Debug: log what we receive from backend
        console.log('Channel data from backend:', data.channels);
        
        if (data.is_member) {
            // User is verified - show success
            const channelCount = data.channel_count || data.channels?.length || 0;
            showResult(`✅ VERIFICATION SUCCESSFUL! You have joined all ${channelCount} required channels.`, true, data.channels || [], channelCount);
        } else {
            // User is not a member of all channels
            const channelCount = data.channel_count || data.channels?.length || 0;
            let message = `❌ ACCESS DENIED! You need to join ${channelCount} channel(s) to access this content.`;
            
            if (channelCount > 1) {
                message = `❌ ACCESS DENIED! You need to join all ${channelCount} channels to access this content.`;
            }
            
            showResult(message, false, data.channels || [], channelCount);
        }
        
    } catch (error) {
        console.error('Verification error:', error);
        showResult('❌ ERROR: Failed to verify membership. Please try again.', false, [], 0);
    }
}

// Event listener for verify button
verifyBtn.addEventListener('click', verifyMembership);

// Clean up on page unload
window.addEventListener('beforeunload', () => {
    clearInterval(matrixInterval);
});
</script>
</body>
</html>