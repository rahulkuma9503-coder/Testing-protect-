<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TEAM SECRET â€” Verification</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#000;
  --neon-cyan:#00ffff;
  --neon-purple:#b800ff;
  --neon-pink:#ff00ff;
  --glow-cyan:rgba(0,255,255,0.8);
  --glow-purple:rgba(184,0,255,0.6);
  --neon-green:#00ff00;
}

*{margin:0;padding:0;box-sizing:border-box}

body{
  font-family:'Rajdhani', sans-serif;
  background:#000;
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
  color:white;
  position:relative;
  padding:20px;
  overflow-x:hidden;
}

/* Main Container */
.container{
  background:linear-gradient(135deg, rgba(0,20,40,0.8) 0%, rgba(20,0,40,0.8) 100%);
  padding:clamp(40px, 5vw, 60px) clamp(30px, 5vw, 70px);
  border-radius:30px;
  border:2px solid;
  border-image:linear-gradient(135deg, var(--neon-cyan), var(--neon-purple), var(--neon-pink)) 1;
  backdrop-filter:blur(20px);
  text-align:center;
  position:relative;
  box-shadow:
    0 0 60px rgba(0,255,255,0.4),
    0 0 100px rgba(184,0,255,0.3),
    inset 0 0 40px rgba(0,255,255,0.1);
  z-index:10;
  max-width:min(550px, 90vw);
  width:100%;
  margin:auto;
  overflow:hidden;
  min-height:500px;
  display:flex;
  flex-direction:column;
  justify-content:center;
}

/* Logo/Badge */
.logo-badge{
  width:clamp(80px, 15vw, 100px);
  height:clamp(80px, 15vw, 100px);
  margin:0 auto 20px;
  border-radius:50%;
  background:linear-gradient(135deg, var(--neon-cyan), var(--neon-purple));
  display:flex;
  align-items:center;
  justify-content:center;
  box-shadow:
    0 0 30px var(--glow-cyan),
    0 0 50px var(--glow-purple);
  animation:pulse-badge 2s infinite ease-in-out;
  position:relative;
  padding:5px;
}

@keyframes pulse-badge{
  0%,100%{
    transform:scale(1);
    box-shadow:
      0 0 30px var(--glow-cyan),
      0 0 50px var(--glow-purple);
  }
  50%{
    transform:scale(1.1);
    box-shadow:
      0 0 50px var(--glow-cyan),
      0 0 70px var(--glow-purple),
      0 0 90px rgba(255,0,255,0.3);
  }
}

.logo-badge img{
  width:100%;
  height:100%;
  border-radius:50%;
  object-fit:cover;
}

/* Title */
h1{
  font-family:'Orbitron', sans-serif;
  font-weight:900;
  font-size:clamp(2em, 6vw, 3.2em);
  background:linear-gradient(135deg, var(--neon-cyan) 0%, var(--neon-purple) 50%, var(--neon-pink) 100%);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  background-clip:text;
  margin:0 0 15px 0;
  letter-spacing:4px;
  text-shadow:0 0 30px var(--glow-cyan);
  line-height:1.2;
}

/* Status */
.status{
  font-size:clamp(1.2em, 4vw, 1.5em);
  color:#fff;
  margin:20px 0 10px 0;
  font-weight:300;
  letter-spacing:2px;
  text-transform:uppercase;
  position:relative;
  display:inline-block;
  padding:0 40px;
}

/* Buttons */
.verify-button, .join-now-button{
  padding:clamp(16px, 4vw, 20px) clamp(30px, 6vw, 60px);
  font-size:clamp(1.1em, 3vw, 1.3em);
  border-radius:50px;
  border:2px solid var(--neon-cyan);
  background:linear-gradient(135deg, rgba(0,255,255,0.3), rgba(184,0,255,0.3));
  color:#fff;
  cursor:pointer;
  transition:all 0.3s ease;
  font-family:'Orbitron', sans-serif;
  font-weight:700;
  letter-spacing:3px;
  text-transform:uppercase;
  position:relative;
  overflow:hidden;
  box-shadow:
    0 0 20px var(--glow-cyan),
    inset 0 0 20px rgba(0,255,255,0.1);
  display:block;
  text-decoration:none;
  margin:15px auto;
  width:100%;
  max-width:300px;
}

.verify-button:hover, .join-now-button:hover{
  background:linear-gradient(135deg, rgba(0,255,255,0.5), rgba(184,0,255,0.5));
  transform:translateY(-3px) scale(1.05);
  box-shadow:
    0 0 40px var(--glow-cyan),
    0 0 60px var(--glow-purple),
    0 10px 30px rgba(0,0,0,0.5);
  border-color:var(--neon-purple);
}

.verify-button:disabled, .join-now-button:disabled{
  opacity:0.6;
  cursor:not-allowed;
  transform:none;
}

/* Special button colors */
.verify-button{
  background:linear-gradient(135deg, rgba(0,255,255,0.3), rgba(0,100,255,0.3));
}

.join-now-button{
  background:linear-gradient(135deg, rgba(0,255,0,0.3), rgba(0,128,0,0.3));
  border-color:var(--neon-green);
  box-shadow:0 0 20px rgba(0,255,0,0.5);
}

/* Loading Animation */
.loading{
  display:none;
  font-size:1em;
  color:#aaf;
  margin:20px 0;
  letter-spacing:1px;
  animation:pulse-loading 1.5s infinite ease-in-out;
}

@keyframes pulse-loading{
  0%,100%{opacity:0.5}
  50%{opacity:1}
}

/* Result Messages */
.result-message{
  font-size:clamp(1em, 3vw, 1.2em);
  color:#fff;
  margin:15px 0;
  padding:15px;
  border-radius:10px;
  background:rgba(0,0,0,0.3);
  border-left:3px solid var(--neon-cyan);
  line-height:1.5;
  word-wrap:break-word;
  max-width:500px;
  margin-left:auto;
  margin-right:auto;
}

.success-message{
  border-left-color:var(--neon-green);
  background:rgba(0,255,0,0.1);
}

.warning-message{
  border-left-color:#ff8c00;
  background:rgba(255,165,0,0.1);
}

/* Button Container */
.button-container{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:15px;
  margin:20px 0;
  width:100%;
}

/* Channels List */
.channels-container {
  width:100%;
  max-width:500px;
  margin:20px auto;
}

.channel-item {
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:12px 15px;
  margin-bottom:10px;
  background:linear-gradient(135deg, rgba(0,40,80,0.4), rgba(20,0,40,0.4));
  border-radius:10px;
  border-left:3px solid var(--neon-cyan);
}

.channel-item.joined {
  border-left-color:var(--neon-green);
  background:linear-gradient(135deg, rgba(0,80,40,0.4), rgba(0,40,20,0.4));
}

.channel-item.not-joined {
  border-left-color:#ff8c00;
  background:linear-gradient(135deg, rgba(80,40,0,0.4), rgba(40,20,0,0.4));
}

.channel-info {
  display:flex;
  align-items:center;
  flex:1;
}

.channel-name {
  font-weight:600;
  color:white;
  font-size:1.1em;
  margin-bottom:3px;
  text-transform:uppercase;
  letter-spacing:0.5px;
}

/* Ad Notice */
.ad-notice{
  background:rgba(255,215,0,0.1);
  border:1px solid rgba(255,215,0,0.3);
  border-radius:10px;
  padding:15px;
  margin:15px 0;
  font-size:0.9em;
  color:#ffd700;
}

.ad-notice i{
  margin-right:8px;
}

/* Instructions Box */
.instructions{
  background:rgba(0,40,80,0.5);
  border:2px solid var(--neon-cyan);
  border-radius:15px;
  padding:20px;
  margin:20px 0;
  text-align:left;
  font-size:0.95em;
  line-height:1.6;
}

.instructions h3{
  color:var(--neon-cyan);
  margin-bottom:10px;
  font-family:'Orbitron', sans-serif;
}

.instructions ul{
  padding-left:20px;
  margin:10px 0;
}

.instructions li{
  margin-bottom:8px;
}

/* Responsive */
@media(max-width:480px){
  body{padding:10px}
  .container{
    padding:30px 20px;
    border-radius:20px;
    min-height:450px;
    max-width:95vw;
  }
  .status{padding:0 20px}
  .verify-button, .join-now-button{
    padding:15px 25px;
    font-size:1em;
    min-width:180px;
    max-width:100%;
  }
}
</style>
</head>
<body>

<div class='container'>
  <div class='logo-badge'>
    <img src='https://i.ibb.co/8g2YxXq6/tmpyb9cwaub.jpg' alt='Team Secret Logo'>
  </div>
  
  <h1>TEAM SECRET</h1>
  <div class='status'>Channel Verification</div>
  <div id="fullname" class='fullname-display'>User</div>
  
  <!-- Initial State -->
  <div id="initial-state" class='button-container'>
    <div class="instructions">
      <h3>ðŸ“‹ How to Access:</h3>
      <p>Follow these steps to unlock the protected content:</p>
      <ul>
        <li>1. Click "Verify Membership" below</li>
        <li>2. Join the required channels (if any)</li>
        <li>3. Watch a short advertisement</li>
        <li>4. Get redirected to the protected content</li>
      </ul>
      <p><strong>Note:</strong> You'll need to watch a 5-10 second ad to access the content.</p>
    </div>
    
    <button id="verifyBtn" class='verify-button'>
      <span class='button-text'>Verify Membership</span>
    </button>
  </div>
  
  <!-- Verification Result -->
  <div id="result-section" style="display:none;">
    <div id="result-message" class='result-message'></div>
    
    <!-- Channels List -->
    <div id="channels-container" class="channels-container" style="display:none;">
      <div id="channels-list"></div>
    </div>
    
    <!-- Ad Notice -->
    <div class="ad-notice" id="adNotice" style="display:none;">
      <i class="fas fa-ad"></i> Please watch a short ad to access the protected content
    </div>
    
    <!-- Action Buttons -->
    <div id="action-buttons" class='button-container'></div>
    
    <!-- Manual Link -->
    <div id="manualLink" style="display:none; margin-top:20px;">
      <p style="color:#aaa; font-size:0.9em; margin-bottom:10px;">If automatic redirect doesn't work:</p>
      <a href="#" id="directLink" style="color:#00ffff; text-decoration:none; word-break:break-all; font-size:0.9em;">Click here to access manually</a>
    </div>
  </div>
  
  <!-- Loading -->
  <div id="loading" class='loading'>Processing...</div>
</div>

<!-- SIMPLE SCRIPT -->
<script>
const token = "{{ token }}";
let currentUserId = null;

// Display user info
try {
    const urlParams = new URLSearchParams(window.location.search);
    const userId = urlParams.get('user_id');
    const userName = urlParams.get('username');
    
    if (userId) currentUserId = userId;
    if (userName) {
        document.getElementById('fullname').textContent = decodeURIComponent(userName);
    }
} catch(e) {
    console.log('Could not get user info');
}

// Elements
const verifyBtn = document.getElementById('verifyBtn');
const loading = document.getElementById('loading');
const initialState = document.getElementById('initial-state');
const resultSection = document.getElementById('result-section');
const resultMessage = document.getElementById('result-message');
const actionButtons = document.getElementById('action-buttons');
const channelsContainer = document.getElementById('channels-container');
const channelsList = document.getElementById('channels-list');
const adNotice = document.getElementById('adNotice');
const manualLink = document.getElementById('manualLink');

// Verify membership
async function verifyMembership() {
    if (!currentUserId) {
        showResult('Please open this link in Telegram to verify.', false);
        return;
    }
    
    verifyBtn.disabled = true;
    verifyBtn.querySelector('.button-text').textContent = 'Checking...';
    loading.style.display = 'block';
    loading.textContent = 'Verifying membership...';
    
    try {
        const response = await fetch(`/check_membership/${token}?user_id=${currentUserId}`);
        
        if (!response.ok) {
            throw new Error('Verification failed');
        }
        
        const data = await response.json();
        
        if (data.is_member) {
            // User is verified
            showResult(`âœ… VERIFICATION SUCCESSFUL! You can now access the protected content.`, true, data.channels);
        } else {
            // User needs to join channels
            showResult(`âŒ You need to join ${data.channel_count} channel(s) to access this content.`, false, data.channels);
        }
        
    } catch (error) {
        console.error('Error:', error);
        showResult('âŒ Verification failed. Please try again.', false);
    }
}

// Show result
function showResult(message, isSuccess, channels = []) {
    loading.style.display = 'none';
    initialState.style.display = 'none';
    resultSection.style.display = 'block';
    
    resultMessage.textContent = message;
    resultMessage.className = `result-message ${isSuccess ? 'success-message' : 'warning-message'}`;
    
    // Show channels if available
    if (channels && channels.length > 0) {
        channelsList.innerHTML = '';
        channels.forEach(channel => {
            const channelItem = document.createElement('div');
            channelItem.className = `channel-item ${channel.is_member ? 'joined' : 'not-joined'}`;
            channelItem.innerHTML = `
                <div class="channel-info">
                    <div>
                        <div class="channel-name">${channel.channel_title || channel.display_name || channel.channel}</div>
                        <div style="font-size:0.8em; color:#aaa;">${channel.is_member ? 'âœ“ Joined' : 'âœ— Not Joined'}</div>
                    </div>
                </div>
                ${!channel.is_member && channel.invite_link ? 
                    `<a href="${channel.invite_link}" target="_blank" style="color:#ff8c00; text-decoration:none; font-size:0.9em;">Join</a>` : 
                    ''}
            `;
            channelsList.appendChild(channelItem);
        });
        channelsContainer.style.display = 'block';
    }
    
    // Create buttons
    if (isSuccess) {
        adNotice.style.display = 'block';
        actionButtons.innerHTML = `
            <button id="accessBtn" class="join-now-button">
                <span class="button-text">Watch Ad & Access Content</span>
            </button>
            <button id="checkAgainBtn" style="background:transparent; border:1px solid #aaa; color:#aaa; padding:10px 20px; border-radius:25px; cursor:pointer;">
                Verify Again
            </button>
        `;
        
        // Add event listeners
        setTimeout(() => {
            document.getElementById('accessBtn').addEventListener('click', accessContent);
            document.getElementById('checkAgainBtn').addEventListener('click', resetVerification);
        }, 100);
        
    } else {
        actionButtons.innerHTML = `
            <button id="checkAgainBtn" class="verify-button">
                <span class="button-text">Verify Again</span>
            </button>
        `;
        
        setTimeout(() => {
            document.getElementById('checkAgainBtn').addEventListener('click', resetVerification);
        }, 100);
    }
}

// Reset verification
function resetVerification() {
    resultSection.style.display = 'none';
    initialState.style.display = 'block';
    verifyBtn.disabled = false;
    verifyBtn.querySelector('.button-text').textContent = 'Verify Membership';
    manualLink.style.display = 'none';
}

// Access content with ad
async function accessContent() {
    const accessBtn = document.getElementById('accessBtn');
    const loading = document.getElementById('loading');
    
    accessBtn.disabled = true;
    accessBtn.querySelector('.button-text').textContent = 'Processing...';
    loading.style.display = 'block';
    loading.textContent = 'Getting protected link...';
    
    try {
        // Get the protected link
        const response = await fetch(`/getgrouplink/${token}`);
        
        if (!response.ok) {
            throw new Error('Failed to get protected link');
        }
        
        const data = await response.json();
        const protectedUrl = data.url;
        
        if (!protectedUrl) {
            throw new Error('No protected link found');
        }
        
        // Store for manual access
        const directLink = document.getElementById('directLink');
        directLink.href = protectedUrl;
        directLink.textContent = protectedUrl;
        
        // Show ad overlay
        loading.textContent = 'Loading advertisement...';
        
        const adOverlay = document.createElement('div');
        adOverlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            text-align: center;
            padding: 20px;
        `;
        
        adOverlay.innerHTML = `
            <div style="font-size: 1.5em; color: #00ffff; margin-bottom: 20px;">
                ðŸ“º Advertisement
            </div>
            <div style="margin-bottom: 30px; max-width: 400px;">
                Please wait while the ad loads...<br>
                This will close in <span id="countdown">5</span> seconds
            </div>
            <div style="background: rgba(0,255,255,0.1); padding: 20px; border-radius: 10px; border: 1px solid #00ffff; margin-bottom: 20px;">
                <strong>Sponsored Content</strong><br>
                Support our bot by watching this short ad
            </div>
            <button id="skipAdBtn" style="padding: 10px 20px; background: #ff8c00; color: white; border: none; border-radius: 25px; cursor: pointer; margin-bottom: 20px;">
                Skip Ad & Continue
            </button>
            <div style="font-size: 0.9em; color: #aaa; margin-top: 20px;">
                After the ad, you'll be redirected automatically
            </div>
        `;
        
        document.body.appendChild(adOverlay);
        
        // Countdown
        let countdown = 5;
        const countdownElement = document.getElementById('countdown');
        const countdownInterval = setInterval(() => {
            countdown--;
            countdownElement.textContent = countdown;
            
            if (countdown <= 0) {
                clearInterval(countdownInterval);
                completeAccess(protectedUrl, adOverlay);
            }
        }, 1000);
        
        // Skip button
        document.getElementById('skipAdBtn').onclick = () => {
            clearInterval(countdownInterval);
            completeAccess(protectedUrl, adOverlay);
        };
        
        // Click anywhere to skip
        adOverlay.onclick = (e) => {
            if (e.target === adOverlay) {
                clearInterval(countdownInterval);
                completeAccess(protectedUrl, adOverlay);
            }
        };
        
    } catch (error) {
        console.error('Error:', error);
        loading.textContent = 'Error! Please try again';
        manualLink.style.display = 'block';
        
        setTimeout(() => {
            resetAccessButton();
        }, 3000);
    }
}

// Complete access
function completeAccess(protectedUrl, adOverlay) {
    // Remove ad overlay
    if (adOverlay && adOverlay.parentNode) {
        adOverlay.parentNode.removeChild(adOverlay);
    }
    
    // Show final message
    const loading = document.getElementById('loading');
    loading.textContent = 'Redirecting to protected content...';
    
    // Try to open Telegram link
    try {
        if (window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.openTelegramLink(protectedUrl);
        } else {
            window.open(protectedUrl, '_blank');
        }
        
        // Close WebApp after 2 seconds
        setTimeout(() => {
            try {
                if (window.Telegram && window.Telegram.WebApp) {
                    window.Telegram.WebApp.close();
                }
            } catch(e) {
                // WebApp already closed
            }
        }, 2000);
        
    } catch (e) {
        manualLink.style.display = 'block';
        loading.textContent = 'Click the link above to access manually';
    }
}

// Reset access button
function resetAccessButton() {
    const accessBtn = document.getElementById('accessBtn');
    const loading = document.getElementById('loading');
    
    if (accessBtn) {
        accessBtn.disabled = false;
        accessBtn.querySelector('.button-text').textContent = 'Watch Ad & Access Content';
    }
    loading.style.display = 'none';
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    verifyBtn.addEventListener('click', verifyMembership);
    
    // Add Font Awesome
    const faScript = document.createElement('script');
    faScript.src = 'https://kit.fontawesome.com/a076d05399.js';
    faScript.crossOrigin = 'anonymous';
    document.head.appendChild(faScript);
});
</script>

</body>
</html>